<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>MapCoder 资源生成器</title>
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Prism Syntax Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <style>
        body { font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif; background-color: #fff; padding: 20px; color: #333; }
        .container { background: white; padding: 30px; border: 1px solid #eee; margin-bottom: 40px; max-width: 1100px; }
        h2 { border-left: 5px solid #007acc; padding-left: 15px; color: #2c3e50; margin-bottom: 25px; }
        
        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #e1e4e8; padding: 12px 15px; text-align: left; vertical-align: middle; }
        th { background-color: #f6f8fa; font-weight: bold; color: #24292e; }
        .code-file { background: #f1f8ff; color: #0366d6; padding: 2px 5px; border-radius: 3px; font-family: Consolas, monospace; font-size: 0.9em; }
        
        /* Annotation Section Styles */
        .annotation-block { display: flex; margin-bottom: 30px; border: 1px solid #e1e4e8; border-radius: 6px; overflow: hidden; }
        .code-part { flex: 6; background: #2d2d2d; padding: 0; margin: 0; }
        .desc-part { flex: 4; background: #f8f9fa; padding: 20px; border-left: 1px solid #e1e4e8; }
        
        .desc-part h3 { margin-top: 0; color: #007acc; font-size: 1.1em; }
        .desc-part p { font-size: 0.95em; line-height: 1.6; color: #555; }
        .desc-part ul { padding-left: 20px; margin-top: 10px; }
        .desc-part li { margin-bottom: 5px; font-size: 0.9em; }
        
        .formula-tag { display: inline-block; background: #e1ecf4; color: #39739d; padding: 2px 8px; border-radius: 12px; font-size: 0.85em; margin-bottom: 10px; font-weight: bold; }

        pre { margin: 0 !important; border-radius: 0 !important; border: none !important; height: 100%; }
        code { font-family: Consolas, 'Courier New', monospace !important; font-size: 13px !important; }
    </style>
</head>
<body>

    <!-- 1. 截图区域：公式对照表 -->
    <div class="container" id="formula-table">
        <h2>MapCoder: 论文公式与代码对照</h2>
        <table>
            <thead>
                <tr>
                    <th style="width: 10%">阶段</th>
                    <th style="width: 30%">核心公式 (Formula)</th>
                    <th style="width: 25%">代码文件</th>
                    <th style="width: 35%">关键代码位置</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Recall</strong><br><span style="font-size:0.8em;color:#666">知识检索</span></td>
                    <td>\( KB, E = \mathcal{M}_{recall}(P) \)</td>
                    <td><span class="code-file">MapCoder.py</span></td>
                    <td>
                        <strong>Line 341</strong>: 构造检索 Prompt<br>
                        <strong>Line 367</strong>: 执行检索 (GPT Call)
                    </td>
                </tr>
                <tr>
                    <td><strong>Plan</strong><br><span style="font-size:0.8em;color:#666">规划</span></td>
                    <td>\( \pi, T = \mathcal{M}_{plan}(P, KB, E) \)</td>
                    <td><span class="code-file">MapCoder.py</span></td>
                    <td>
                        <strong>Line 406</strong>: 构造规划 Prompt<br>
                        <strong>Line 430</strong>: 生成计划与测试用例
                    </td>
                </tr>
                <tr>
                    <td><strong>Code</strong><br><span style="font-size:0.8em;color:#666">编码</span></td>
                    <td>\( C = \mathcal{M}_{code}(P, \pi, T) \)</td>
                    <td><span class="code-file">MapCoder.py</span></td>
                    <td>
                        <strong>Line 524</strong>: 构造编码 Prompt<br>
                        <strong>Line 547</strong>: 生成最终代码
                    </td>
                </tr>
                <tr>
                    <td><strong>Refine</strong><br><span style="font-size:0.8em;color:#666">调试修正</span></td>
                    <td>\( C_{i+1} = \mathcal{M}_{debug}(C_i, F) \)</td>
                    <td><span class="code-file">MapCoder.py</span></td>
                    <td>
                        <strong>Line 654</strong>: 构造修正 Prompt<br>
                        <strong>Line 679</strong>: 迭代修复代码
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- 2. 截图区域：代码详细注释 -->
    <div class="container" id="code-annotations">
        <h2>MapCoder: 核心代码实现详解</h2>

        <!-- Recall Block -->
        <div class="annotation-block">
            <div class="code-part">
<pre><code class="language-python"># 1. Knowledge Retrieval (Recall)
kb_exemplars_prompt = [
    {
        "role": "system",
        # 设定为“代码合成专家”，负责回忆相关知识
        "content": "You are an expert code synthesis assistant..."
    },
    {
        "role": "user",
        # 请求生成知识库(KB)和相似样例(Exemplars)
        "content": f"Problem: {problem_description}..."
    }
]
# 执行 LLM 调用，获取先验知识
self.gpt_chat(prompt=kb_exemplars_prompt)</code></pre>
            </div>
            <div class="desc-part">
                <div class="formula-tag">Formula (1): Recall</div>
                <h3>知识检索阶段</h3>
                <p>对应论文中的 \( KB, E = \mathcal{M}_{recall}(P) \)。</p>
                <ul>
                    <li><strong>目标</strong>：在正式编码前，检索与题目相关的算法概念（如动态规划、DFS）和相似题目样例。</li>
                    <li><strong>实现</strong>：通过 `kb_exemplars_prompt` 引导模型生成 XML 格式的知识库。</li>
                </ul>
            </div>
        </div>

        <!-- Plan Block -->
        <div class="annotation-block">
            <div class="code-part">
<pre><code class="language-python"># 2. Planning
planning_prompt = [
    {
        "role": "system",
        # 设定为“规划代理”，制定分步解题计划
        "content": "You are a planning agent..."
    },
    {
        "role": "user",
        # 输入题目、知识库(KB)和样例(E)
        "content": f"Problem... KB... Exemplars... Create a plan..."
    }
]
# 生成解题计划(\pi)和测试用例(T)
self.gpt_chat(prompt=planning_prompt)</code></pre>
            </div>
            <div class="desc-part">
                <div class="formula-tag">Formula (2): Plan</div>
                <h3>规划阶段</h3>
                <p>对应论文中的 \( \pi, T = \mathcal{M}_{plan}(P, KB, E) \)。</p>
                <ul>
                    <li><strong>目标</strong>：利用检索到的知识，制定详细的 Step-by-step 解题计划，并预先生成测试用例。</li>
                    <li><strong>关键点</strong>：将复杂的编程任务拆解为自然语言描述的逻辑步骤。</li>
                </ul>
            </div>
        </div>

        <!-- Code Block -->
        <div class="annotation-block">
            <div class="code-part">
<pre><code class="language-python"># 3. Code Generation
code_gen_prompt = [
    {
        "role": "system",
        "content": "You are a coding agent..."
    },
    {
        "role": "user",
        # 结合规划(Plan)、测试用例(Test Cases)与约束生成代码
        "content": f"Plan: {plan}\nTest cases: {test_cases}..."
    }
]
# 执行生成，获取初始代码(C)
if not is_turbo:
    self.gpt_chat(prompt=code_gen_prompt)</code></pre>
            </div>
            <div class="desc-part">
                <div class="formula-tag">Formula (3): Code</div>
                <h3>编码阶段</h3>
                <p>对应论文中的 \( C = \mathcal{M}_{code}(P, \pi, T) \)。</p>
                <ul>
                    <li><strong>目标</strong>：将规划阶段生成的自然语言逻辑翻译为可执行的代码。</li>
                    <li><strong>优势</strong>：由于有了详细的规划，模型只需专注于语法实现，降低了推理难度。</li>
                </ul>
            </div>
        </div>

        <!-- Debug Block -->
        <div class="annotation-block">
            <div class="code-part">
<pre><code class="language-python"># 4. Iterative Refinement (Debug)
for i in range(self.max_retries):
    # ... (执行代码并获取反馈 Feedback) ...
    
    improvement_prompt = [
        {
            "role": "system",
            "content": "You are a debugging agent..."
        },
        {
            "role": "user",
            # 传入当前代码和报错信息/未通过的测试用例
            "content": f"Current code: {code}\nFeedback: {feedback}..."
        }
    ]
    # 根据反馈生成修复后的代码(C_new)
    self.gpt_chat(prompt=improvement_prompt)</code></pre>
            </div>
            <div class="desc-part">
                <div class="formula-tag">Formula (4): Refine</div>
                <h3>调试修正阶段</h3>
                <p>对应论文中的 \( C_{i+1} = \mathcal{M}_{debug}(C_i, F) \)。</p>
                <ul>
                    <li><strong>机制</strong>：模拟人类“编写-运行-报错-修改”的闭环。</li>
                    <li><strong>输入</strong>：错误信息（Feedback）作为关键线索指导模型修复 Bug。</li>
                </ul>
            </div>
        </div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
</body>
</html>